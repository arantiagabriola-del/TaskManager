{% extends 'base.html' %}
{% block title %}Focus Mode | Taskify{% endblock %}

{% block content %}
<div class="container text-center" style="margin-top:60px; max-width:700px;">

  <!-- Header -->
  <h1 style="font-family: 'Orbitron', sans-serif; color:#00ffff; text-shadow:0 0 15px #00ffff;">
    üöÄ Focus Mode, {{ request.user.username }}
  </h1>
  <p style="color:#b0b0b0; font-size:1.1rem; margin-bottom:30px;">
    Focus on one task at a time and boost your productivity!
  </p>

  <!-- Focus Time Picker -->
  <div class="mb-3">
    <label for="focusMinutes" style="color:#ffb400; font-weight:bold;">
      ‚è± Choose your focus time (minutes):
    </label>
    <input type="number" id="focusMinutes" value="25" min="20" max="120"
           style="width:100px; text-align:center; border-radius:8px; border:1px solid #00ffff; color:#00ffff; background:#0a0a1e;">
  </div>

  <!-- Focus Mode Button -->
  <div style="margin-bottom:20px;">
    <button id="focusModeBtn" class="btn-neon btn-lg">‚ö° Start Focus Mode</button>
  </div>

  <!-- Notification -->
  <div id="focusNotice" style="display:none; color:#00ffff; font-size:1.1rem; margin-bottom:15px;"></div>

  <!-- Focus Timer -->
  <div id="focusTimer" style="display:none; margin-bottom:30px;">
    <h3>‚è≥ Focus Time: <span id="timer">25:00</span></h3>
    <button id="stopFocus" class="btn-neon mt-2">Stop Focus</button>
  </div>

  <!-- All Pending Tasks (Sorted) -->
  <div id="focusTaskContainer">
    {% if pending_tasks %}
      {% for task in pending_tasks|dictsortreversed:"priority"|dictsort:"due_date" %}
      <div class="card-futuristic p-4 mb-3" data-priority="{{ task.priority|lower }}" data-due="{{ task.due_date|date:'Y-m-d' }}">
        <h3>{{ task.title }}</h3>
        {% if task.description %}
          <p>{{ task.description }}</p>
        {% endif %}
        <small style="color:#00ffff;">Due: {{ task.due_date|date:"M d, Y" }}</small> |
        <small style="color:#ffb400;">Priority: {{ task.priority }}</small> |
        <small style="color:#ff6fff;">
          Categories:
          {% if task.categories.all %}
            {% for cat in task.categories.all %}
              {{ cat.title }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            None
          {% endif %}
        </small>
        <div class="mt-3">
          <a href="{% url 'task_update' task.pk %}" class="btn btn-sm btn-neon">Edit</a>
          <a href="{% url 'task_delete' task.pk %}" class="btn btn-sm btn-danger">Delete</a>
          <a href="{% url 'task_complete' task.pk %}" class="btn btn-sm btn-success">Mark Complete</a>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p style="color:#888; font-size:1rem;">No pending tasks. Add one in the dashboard!</p>
    {% endif %}
  </div>
</div>

<!-- Focus Mode Timer + Highlight Script -->
<script>
let focusTime = 25 * 60;
let timerInterval;

document.getElementById('focusModeBtn').addEventListener('click', () => {
  const tasks = document.querySelectorAll('#focusTaskContainer .card-futuristic');
  if (tasks.length === 0) {
    alert('All tasks are completed! üéâ');
    return;
  }

  // Highlight highest-priority + earliest-due task
  let bestTask = null;
  const priorityRank = { 'High': 3, 'Medium': 2, 'Low': 1 };

  tasks.forEach(task => {
    const priority = task.getAttribute('data-priority');
    const due = new Date(task.getAttribute('data-due'));
    if (!bestTask) {
      bestTask = task;
    } else {
      const bestPriority = bestTask.getAttribute('data-priority');
      const bestDue = new Date(bestTask.getAttribute('data-due'));
      if (priorityRank[priority.charAt(0).toUpperCase() + priority.slice(1)] > priorityRank[bestPriority.charAt(0).toUpperCase() + bestPriority.slice(1)] ||
          (priorityRank[priority.charAt(0).toUpperCase() + priority.slice(1)] === priorityRank[bestPriority.charAt(0).toUpperCase() + bestPriority.slice(1)] && due < bestDue)) {
        bestTask = task;
      }
    }
  });

  if (bestTask) {
    bestTask.classList.add('highlight-task');
    bestTask.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  const input = document.getElementById('focusMinutes');
  let chosenMinutes = parseInt(input.value);

  // Validate input
  if (isNaN(chosenMinutes) || chosenMinutes < 20 || chosenMinutes > 120) {
    alert('Please choose a time between 20 and 120 minutes.');
    return;
  }

  // Show notification
  const notice = document.getElementById('focusNotice');
  notice.style.display = 'block';
  notice.textContent = `üïí You need to finish your task in ${chosenMinutes} minutes!`;

  document.getElementById('focusTimer').style.display = 'block';
  focusTime = chosenMinutes * 60;

  // Start timer
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const minutes = Math.floor(focusTime / 60);
    const seconds = focusTime % 60;
    document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    if (focusTime <= 0) {
      clearInterval(timerInterval);
      alert('‚è∞ Time‚Äôs up! Focus session complete! üéØ');
      window.location.reload();
    }
    focusTime--;
  }, 1000);
});

document.getElementById('stopFocus').addEventListener('click', () => {
  clearInterval(timerInterval);
  alert('üõë Focus session stopped.');
  window.location.reload();
});
</script>

<!-- Styles -->
<style>
.card-futuristic {
  background: rgba(10,10,30,0.85);
  border: 1px solid #00ffff30;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 0 15px #00ffff20;
  transition: box-shadow 0.3s ease, transform 0.3s ease;
  text-align: left;
}
.card-futuristic:hover { box-shadow:0 0 25px #00ffff50; transform:scale(1.02); }

.highlight-task {
  border: 2px solid #ffb400;
  box-shadow: 0 0 30px #ffb40090;
  transform: scale(1.03);
  animation: pulse 1.5s infinite alternate;
}

@keyframes pulse {
  from { box-shadow: 0 0 15px #ffb40050; }
  to { box-shadow: 0 0 30px #ffb400a0; }
}

.btn-neon {
  background-color: #00ffff10;
  color: #00ffff;
  border: 1px solid #00ffff;
  border-radius: 8px;
  padding: 10px 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}
.btn-neon:hover { 
  box-shadow: 0 0 20px #00ffff;
  background-color: #00ffff20;
  color:#0b0c10;
}
</style>
{% endblock %}
